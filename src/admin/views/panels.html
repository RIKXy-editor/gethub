<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panels - Ticket Admin</title>
  <link rel="stylesheet" href="/admin/css/style.css">
  <style>
    .plan-item { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .plan-item .plan-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .plan-item .plan-header h4 { margin: 0; color: var(--accent-color); }
    .plan-item .plan-fields { display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 12px; }
    .plan-item .form-control { background: var(--card-bg); }
    .remove-plan { background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 18px; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ« Ticket Admin</h1>
    </div>
    <ul class="sidebar-nav">
      <li><a href="/admin"><span class="icon">ğŸ“Š</span> Dashboard</a></li>
      <li><a href="/admin/tickets"><span class="icon">ğŸ«</span> Tickets</a></li>
      <li><a href="/admin/panels" class="active"><span class="icon">ğŸ“‹</span> Panels</a></li>
      <li><a href="/admin/embed-builder"><span class="icon">ğŸ¨</span> Embed Builder</a></li>
      <li><a href="/admin/welcome"><span class="icon">ğŸ‘‹</span> Welcome</a></li>
      <li><a href="/admin/keywords"><span class="icon">ğŸ”‘</span> Keywords</a></li>
      <li><a href="/admin/giveaways"><span class="icon">ğŸ</span> Giveaways</a></li>
      <li><a href="/admin/announcements"><span class="icon">ğŸ“¢</span> Announcements</a></li>
      <li><a href="/admin/scheduled"><span class="icon">â°</span> Scheduled</a></li>
      <li><a href="/admin/sticky"><span class="icon">ğŸ“Œ</span> Sticky</a></li>
      <li><a href="/admin/dm-sender"><span class="icon">âœ‰ï¸</span> DM Sender</a></li>
      <li><a href="/admin/job-config"><span class="icon">ğŸ’¼</span> Job Config</a></li>
      <li><a href="/admin/bot-settings"><span class="icon">ğŸ¤–</span> Bot Settings</a></li>
      <li><a href="/admin/settings"><span class="icon">âš™ï¸</span> Settings</a></li>
      <li><a href="/admin/stats"><span class="icon">ğŸ“ˆ</span> Staff Stats</a></li>
      <li><a href="/admin/logout"><span class="icon">ğŸšª</span> Logout</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="page-header">
      <h2>Ticket Panels</h2>
      <p>Configure and customize your ticket panel embeds</p>
    </div>

    <div class="guild-selector">
      <label style="margin-right:10px;">Select Server:</label>
      <select id="guildSelect" class="form-control" style="width:auto;display:inline-block;"></select>
    </div>

    <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
      <div class="card">
        <div class="card-header">
          <h3>ğŸ“‹ Panel Embed</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Panel Title</label>
            <input type="text" class="form-control" id="panelTitle" placeholder="ğŸ« Support Tickets">
          </div>
          <div class="form-group">
            <label>Panel Description</label>
            <textarea class="form-control" id="panelDescription" placeholder="Click the button below to create a ticket"></textarea>
          </div>
          <div class="form-group">
            <label>Panel Color (hex)</label>
            <input type="text" class="form-control" id="panelColor" placeholder="#dc2626">
          </div>
          <div class="form-group">
            <label>Button Label</label>
            <input type="text" class="form-control" id="buttonLabel" placeholder="Open Ticket">
          </div>
          <div class="form-group">
            <label>Button Color</label>
            <select class="form-control" id="buttonColor">
              <option value="Primary">Blue</option>
              <option value="Success">Green</option>
              <option value="Danger">Red</option>
              <option value="Secondary">Gray</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="savePanelSettings()">Save Panel Settings</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>ğŸ« Ticket Opening Embed</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Ticket Title</label>
            <input type="text" class="form-control" id="ticketTitle" placeholder="ğŸ« Support Ticket">
          </div>
          <div class="form-group">
            <label>Ticket Description</label>
            <textarea class="form-control" id="ticketDescription" placeholder="Welcome {user}!\n\nPlease select your subscription plan below."></textarea>
          </div>
          <p style="color:var(--text-secondary);font-size:0.85rem;margin-top:10px;">Use {user} to mention the ticket opener</p>
          <button class="btn btn-primary" onclick="saveTicketSettings()">Save Ticket Settings</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="card-header">
        <h3>ğŸš€ Post Panel to Channel</h3>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label>Select Channel</label>
          <select class="form-control" id="postChannelId"></select>
        </div>
        <button class="btn btn-primary" onclick="postPanel()" style="width:100%;">Post Ticket Panel to Channel</button>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="card-header">
        <h3>ğŸ’ Subscription Plans</h3>
      </div>
      <div class="card-body">
        <p style="color:var(--text-secondary);margin-bottom:16px;">Configure subscription plans that users can select when opening tickets</p>
        <div id="plansContainer"></div>
        <button class="btn btn-secondary" onclick="addPlan()" style="margin-top:12px;">+ Add Plan</button>
        <button class="btn btn-primary" onclick="savePlans()" style="margin-top:12px;margin-left:8px;">Save Plans</button>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="card-header">
        <h3>âš™ï¸ Panel Configuration</h3>
      </div>
      <div class="card-body">
        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="form-group">
            <label>Category ID</label>
            <input type="text" class="form-control" id="categoryId" placeholder="Discord Category ID">
          </div>
          <div class="form-group">
            <label>Support Role ID</label>
            <input type="text" class="form-control" id="supportRoleId" placeholder="Discord Role ID">
          </div>
          <div class="form-group">
            <label>Logs Channel ID</label>
            <input type="text" class="form-control" id="logsChannelId" placeholder="Discord Channel ID">
          </div>
        </div>
        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="form-group">
            <label>Cooldown (seconds)</label>
            <input type="number" class="form-control" id="cooldownSeconds" placeholder="60">
          </div>
          <div class="form-group">
            <label>Max Tickets Per User</label>
            <input type="number" class="form-control" id="maxTicketsPerUser" placeholder="1">
          </div>
          <div class="form-group">
            <label>Ratings Enabled</label>
            <select class="form-control" id="ratingsEnabled">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>
  <script src="/admin/js/unsaved.js"></script>
  <script>
    let currentGuildId = null;
    let subscriptionPlans = [];
    
    async function loadGuilds() {
      try {
        const res = await fetch('/admin/api/discord/guilds');
        const guilds = await res.json();
        const select = document.getElementById('guildSelect');
        
        if (guilds.length === 0) {
          select.innerHTML = '<option value="">No servers configured</option>';
          return;
        }
        
        select.innerHTML = guilds.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
        currentGuildId = guilds[0].id;
        loadConfig();
        loadChannels();
        loadPlans();
      } catch (err) {
        console.error('Error loading guilds:', err);
      }
    }
    
    async function loadConfig() {
      if (!currentGuildId) return;
      
      try {
        const res = await fetch(`/admin/api/config/${currentGuildId}`);
        const config = await res.json();
        
        document.getElementById('panelTitle').value = config.panelEmbed?.title || '';
        document.getElementById('panelDescription').value = config.panelEmbed?.description || '';
        document.getElementById('panelColor').value = config.panelEmbed?.color || '';
        document.getElementById('buttonLabel').value = config.buttonLabel || '';
        document.getElementById('buttonColor').value = config.buttonColor || 'Primary';
        
        document.getElementById('ticketTitle').value = config.ticketEmbed?.title || '';
        document.getElementById('ticketDescription').value = config.ticketEmbed?.description || '';
        
        document.getElementById('categoryId').value = config.categoryId || '';
        document.getElementById('supportRoleId').value = config.supportRoleId || '';
        document.getElementById('logsChannelId').value = config.logsChannelId || '';
        document.getElementById('cooldownSeconds').value = config.cooldownSeconds || 60;
        document.getElementById('maxTicketsPerUser').value = config.maxTicketsPerUser || 1;
        document.getElementById('ratingsEnabled').value = config.ratingsEnabled !== false ? 'true' : 'false';
        setTimeout(() => UnsavedChanges.refresh && UnsavedChanges.refresh(), 100);
      } catch (err) {
        console.error('Error loading config:', err);
      }
    }
    
    async function savePanelSettings() {
      const data = {
        panelEmbed: {
          title: document.getElementById('panelTitle').value,
          description: document.getElementById('panelDescription').value,
          color: document.getElementById('panelColor').value
        },
        buttonLabel: document.getElementById('buttonLabel').value,
        buttonColor: document.getElementById('buttonColor').value
      };
      
      await saveToServer(data, 'Panel settings saved');
    }
    
    async function saveTicketSettings() {
      const data = {
        ticketEmbed: {
          title: document.getElementById('ticketTitle').value,
          description: document.getElementById('ticketDescription').value
        }
      };
      
      await saveToServer(data, 'Ticket settings saved');
    }
    
    async function saveConfig() {
      const data = {
        categoryId: document.getElementById('categoryId').value,
        supportRoleId: document.getElementById('supportRoleId').value,
        logsChannelId: document.getElementById('logsChannelId').value,
        cooldownSeconds: parseInt(document.getElementById('cooldownSeconds').value) || 60,
        maxTicketsPerUser: parseInt(document.getElementById('maxTicketsPerUser').value) || 1,
        ratingsEnabled: document.getElementById('ratingsEnabled').value === 'true'
      };
      
      await saveToServer(data, 'Configuration saved');
    }
    
    async function saveToServer(data, successMsg) {
      if (!currentGuildId) return;
      
      try {
        const res = await fetch(`/admin/api/config/${currentGuildId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          showToast(successMsg, 'success');
        } else {
          showToast('Failed to save', 'error');
        }
      } catch (err) {
        showToast('Error saving', 'error');
      }
    }
    
    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    async function loadChannels() {
      if (!currentGuildId) return;
      try {
        const res = await fetch(`/admin/api/discord/guilds/${currentGuildId}/channels`);
        const channels = await res.json();
        const select = document.getElementById('postChannelId');
        select.innerHTML = '<option value="">Select a channel...</option>' + 
          channels.map(ch => `<option value="${ch.id}">#${ch.name}</option>`).join('');
      } catch (err) {
        console.error('Error loading channels:', err);
      }
    }

    async function postPanel() {
      const channelId = document.getElementById('postChannelId').value;
      if (!channelId) {
        showToast('Please select a channel', 'error');
        return;
      }
      if (!currentGuildId) {
        showToast('Please select a server', 'error');
        return;
      }
      try {
        const res = await fetch(`/admin/api/panels/${currentGuildId}/post`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channelId })
        });
        const data = await res.json();
        if (res.ok) {
          showToast('Panel posted successfully!', 'success');
        } else {
          showToast(data.error || 'Failed to post panel', 'error');
        }
      } catch (err) {
        showToast('Error posting panel', 'error');
      }
    }
    
    document.getElementById('guildSelect').addEventListener('change', (e) => {
      currentGuildId = e.target.value;
      loadConfig();
      loadChannels();
      loadPlans();
    });
    
    async function loadPlans() {
      if (!currentGuildId) return;
      try {
        const res = await fetch(`/admin/api/plans/${currentGuildId}`);
        subscriptionPlans = await res.json();
        renderPlans();
        setTimeout(() => UnsavedChanges.refresh && UnsavedChanges.refresh(), 100);
      } catch (err) {
        console.error('Error loading plans:', err);
        subscriptionPlans = [];
        renderPlans();
      }
    }
    
    function renderPlans() {
      const container = document.getElementById('plansContainer');
      if (subscriptionPlans.length === 0) {
        container.innerHTML = '<p style="color:var(--text-secondary);">No plans configured. Add your first subscription plan.</p>';
        return;
      }
      container.innerHTML = subscriptionPlans.map((plan, i) => `
        <div class="plan-item">
          <div class="plan-header">
            <h4>Plan ${i + 1}</h4>
            <button class="remove-plan" onclick="removePlan(${i})">&times;</button>
          </div>
          <div class="plan-fields">
            <div class="form-group">
              <label>Plan Name</label>
              <input type="text" class="form-control plan-name" data-index="${i}" value="${plan.name || ''}" placeholder="e.g. Basic">
            </div>
            <div class="form-group">
              <label>Price</label>
              <input type="text" class="form-control plan-price" data-index="${i}" value="${plan.price || ''}" placeholder="e.g. $9.99/mo">
            </div>
            <div class="form-group">
              <label>Features (comma separated)</label>
              <input type="text" class="form-control plan-features" data-index="${i}" value="${(plan.features || []).join(', ')}" placeholder="Feature 1, Feature 2">
            </div>
          </div>
        </div>
      `).join('');
      
      container.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', updatePlanFromInput);
      });
    }
    
    function updatePlanFromInput(e) {
      const index = parseInt(e.target.dataset.index);
      if (e.target.classList.contains('plan-name')) {
        subscriptionPlans[index].name = e.target.value;
      } else if (e.target.classList.contains('plan-price')) {
        subscriptionPlans[index].price = e.target.value;
      } else if (e.target.classList.contains('plan-features')) {
        subscriptionPlans[index].features = e.target.value.split(',').map(f => f.trim()).filter(f => f);
      }
      UnsavedChanges.markDirty();
    }
    
    function addPlan() {
      subscriptionPlans.push({ name: '', price: '', features: [] });
      renderPlans();
      UnsavedChanges.markDirty();
    }
    
    function removePlan(index) {
      subscriptionPlans.splice(index, 1);
      renderPlans();
      UnsavedChanges.markDirty();
    }
    
    async function savePlans() {
      if (!currentGuildId) return;
      try {
        const res = await fetch(`/admin/api/plans/${currentGuildId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ plans: subscriptionPlans })
        });
        if (res.ok) {
          showToast('Subscription plans saved!', 'success');
          UnsavedChanges.markSaved();
        } else {
          showToast('Failed to save plans', 'error');
        }
      } catch (err) {
        showToast('Error saving plans', 'error');
      }
    }
    
    async function saveAllChanges() {
      await savePanelSettings();
      await saveTicketSettings();
      await saveConfig();
      await savePlans();
      UnsavedChanges.markSaved();
    }
    
    UnsavedChanges.init(saveAllChanges);
    loadGuilds();
  </script>
</body>
</html>
