<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Stats - Ticket Admin</title>
  <link rel="stylesheet" href="/admin/css/style.css">
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ« Ticket Admin</h1>
    </div>
    <ul class="sidebar-nav">
      <li><a href="/admin"><span class="icon">ğŸ“Š</span> Dashboard</a></li>
      <li><a href="/admin/tickets"><span class="icon">ğŸ«</span> Tickets</a></li>
      <li><a href="/admin/panels"><span class="icon">ğŸ“‹</span> Panels</a></li>
      <li><a href="/admin/settings"><span class="icon">âš™ï¸</span> Settings</a></li>
      <li><a href="/admin/stats" class="active"><span class="icon">ğŸ“ˆ</span> Staff Stats</a></li>
      <li><a href="/admin/logout"><span class="icon">ğŸšª</span> Logout</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="page-header">
      <h2>Staff Statistics</h2>
      <p>View staff performance and ratings</p>
    </div>

    <div class="guild-selector">
      <label style="margin-right:10px;">Select Server:</label>
      <select id="guildSelect" class="form-control" style="width:auto;display:inline-block;"></select>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon">ğŸ«</div>
        <div class="value" id="totalTickets">0</div>
        <div class="label">Total Tickets</div>
      </div>
      <div class="stat-card">
        <div class="icon">ğŸ‘¥</div>
        <div class="value" id="totalStaff">0</div>
        <div class="label">Staff Members</div>
      </div>
      <div class="stat-card">
        <div class="icon">â­</div>
        <div class="value" id="avgRating">-</div>
        <div class="label">Average Rating</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Staff Leaderboard</h3>
      </div>
      <div class="card-body">
        <table class="table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Staff ID</th>
              <th>Tickets Claimed</th>
              <th>Average Rating</th>
              <th>Total Ratings</th>
            </tr>
          </thead>
          <tbody id="staffTable">
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    let currentGuildId = null;
    
    async function loadGuilds() {
      try {
        const res = await fetch('/admin/api/guilds');
        const guilds = await res.json();
        const select = document.getElementById('guildSelect');
        
        if (guilds.length === 0) {
          select.innerHTML = '<option value="">No servers configured</option>';
          return;
        }
        
        select.innerHTML = guilds.map(g => `<option value="${g.id}">${g.id}</option>`).join('');
        currentGuildId = guilds[0].id;
        loadStats();
      } catch (err) {
        console.error('Error loading guilds:', err);
      }
    }
    
    async function loadStats() {
      if (!currentGuildId) return;
      
      try {
        const res = await fetch(`/admin/api/stats/${currentGuildId}`);
        const stats = await res.json();
        
        document.getElementById('totalTickets').textContent = stats.totalTickets || 0;
        
        const staffStats = stats.staffStats || {};
        const staffList = Object.entries(staffStats).map(([id, s]) => ({
          id,
          claimed: s.claimed || 0,
          avgRating: s.ratingCount > 0 ? (s.totalRating / s.ratingCount).toFixed(1) : '-',
          ratingCount: s.ratingCount || 0
        }));
        
        document.getElementById('totalStaff').textContent = staffList.length;
        
        const totalRatings = staffList.reduce((sum, s) => sum + (s.ratingCount || 0), 0);
        const totalRatingSum = Object.values(staffStats).reduce((sum, s) => sum + (s.totalRating || 0), 0);
        document.getElementById('avgRating').textContent = totalRatings > 0 
          ? (totalRatingSum / totalRatings).toFixed(1) + ' â­' 
          : '-';
        
        staffList.sort((a, b) => b.claimed - a.claimed);
        
        const tbody = document.getElementById('staffTable');
        if (staffList.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-secondary)">No staff stats yet</td></tr>';
        } else {
          tbody.innerHTML = staffList.map((s, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${s.id}</td>
              <td>${s.claimed}</td>
              <td>${s.avgRating} ${s.avgRating !== '-' ? 'â­' : ''}</td>
              <td>${s.ratingCount}</td>
            </tr>
          `).join('');
        }
      } catch (err) {
        console.error('Error loading stats:', err);
      }
    }
    
    document.getElementById('guildSelect').addEventListener('change', (e) => {
      currentGuildId = e.target.value;
      loadStats();
    });
    
    loadGuilds();
  </script>
</body>
</html>
