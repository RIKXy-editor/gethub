<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scheduled Messages - Admin</title>
  <link rel="stylesheet" href="/admin/css/style.css">
  <style>
    .schedule-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 900px) { .schedule-grid { grid-template-columns: 1fr; } }
    .form-section { padding: 20px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); }
    .schedule-list { margin-top: 20px; }
    .schedule-item { padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; }
    .schedule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .schedule-channel { color: var(--accent-color); font-weight: 600; }
    .schedule-time { color: var(--text-secondary); font-size: 13px; }
    .schedule-message { color: var(--text-primary); font-size: 14px; margin-top: 8px; white-space: pre-wrap; }
    .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header"><h1>Ticket Admin</h1></div>
    <ul class="sidebar-nav">
      <li><a href="/admin"><span class="icon">ğŸ“Š</span> Dashboard</a></li>
      <li><a href="/admin/tickets"><span class="icon">ğŸ«</span> Tickets</a></li>
      <li><a href="/admin/panels"><span class="icon">ğŸ“‹</span> Panels</a></li>
      <li><a href="/admin/embed-builder"><span class="icon">ğŸ¨</span> Embed Builder</a></li>
      <li><a href="/admin/welcome"><span class="icon">ğŸ‘‹</span> Welcome</a></li>
      <li><a href="/admin/keywords"><span class="icon">ğŸ”‘</span> Keywords</a></li>
      <li><a href="/admin/giveaways"><span class="icon">ğŸ</span> Giveaways</a></li>
      <li><a href="/admin/announcements"><span class="icon">ğŸ“¢</span> Announcements</a></li>
      <li><a href="/admin/scheduled" class="active"><span class="icon">â°</span> Scheduled</a></li>
      <li><a href="/admin/sticky"><span class="icon">ğŸ“Œ</span> Sticky</a></li>
      <li><a href="/admin/sticky-clients"><span class="icon">ğŸ‘¥</span> Client Finder</a></li>
      <li><a href="/admin/dm-sender"><span class="icon">âœ‰ï¸</span> DM Sender</a></li>
      <li><a href="/admin/job-config"><span class="icon">ğŸ’¼</span> Job Config</a></li>
      <li><a href="/admin/bot-settings"><span class="icon">ğŸ¤–</span> Bot Settings</a></li>
      <li><a href="/admin/settings"><span class="icon">âš™ï¸</span> Settings</a></li>
      <li><a href="/admin/logout"><span class="icon">ğŸšª</span> Logout</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="page-header">
      <h2>Scheduled Messages</h2>
      <p>Schedule messages to be sent automatically</p>
    </div>

    <div class="form-section" style="padding:16px;">
      <label style="margin-right:10px;">Select Server:</label>
      <select id="guildSelect" style="width:auto;display:inline-block;padding:8px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);"></select>
    </div>

    <div class="schedule-grid">
      <div class="form-section">
        <h3 style="margin:0 0 16px;color:var(--accent-color);">Create Schedule</h3>
        <div class="form-group">
          <label>Channel</label>
          <select id="channelId"></select>
        </div>
        <div class="form-group">
          <label>Message</label>
          <textarea id="message" placeholder="Message to send..." style="min-height:100px;"></textarea>
        </div>
        <div class="form-group">
          <label>Send Time</label>
          <input type="time" id="sendTime" value="09:00">
        </div>
        <div class="form-group">
          <label>Frequency</label>
          <select id="frequency">
            <option value="once">Once (today)</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
          </select>
        </div>
        <div class="form-group" id="dayOfWeekGroup" style="display:none;">
          <label>Day of Week</label>
          <select id="dayOfWeek">
            <option value="0">Sunday</option>
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
          </select>
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="createSchedule()">Create Schedule</button>
      </div>

      <div>
        <h3 style="margin:0 0 16px;color:var(--accent-color);">Active Schedules</h3>
        <div id="scheduleList" class="schedule-list">
          <div class="empty-state">Loading...</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentGuildId = null;
    let schedules = [];

    async function loadGuilds() {
      const res = await fetch('/admin/api/discord/guilds');
      const guilds = await res.json();
      const select = document.getElementById('guildSelect');
      guilds.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name;
        select.appendChild(opt);
      });
      if (guilds.length > 0) {
        currentGuildId = guilds[0].id;
        loadChannels();
        loadSchedules();
      }
    }

    async function loadChannels() {
      const res = await fetch(`/admin/api/discord/guilds/${currentGuildId}/channels`);
      const channels = await res.json();
      document.getElementById('channelId').innerHTML = channels.map(ch => `<option value="${ch.id}">#${ch.name}</option>`).join('');
    }

    async function loadSchedules() {
      const res = await fetch(`/admin/api/scheduled/${currentGuildId}`);
      schedules = await res.json();
      renderSchedules();
    }

    function renderSchedules() {
      const container = document.getElementById('scheduleList');
      if (schedules.length === 0) {
        container.innerHTML = '<div class="empty-state">No scheduled messages</div>';
        return;
      }
      container.innerHTML = schedules.map(s => `
        <div class="schedule-item">
          <div class="schedule-header">
            <span class="schedule-channel">#${s.channelName || s.channelId}</span>
            <button class="btn btn-secondary" onclick="deleteSchedule('${s.id}')" style="padding:4px 12px;font-size:12px;">Delete</button>
          </div>
          <div class="schedule-time">${s.time} - ${s.frequency}</div>
          <div class="schedule-message">${s.message.substring(0, 100)}${s.message.length > 100 ? '...' : ''}</div>
        </div>
      `).join('');
    }

    async function createSchedule() {
      const message = document.getElementById('message').value.trim();
      if (!message) { alert('Please enter a message'); return; }

      const data = {
        channelId: document.getElementById('channelId').value,
        message,
        time: document.getElementById('sendTime').value,
        frequency: document.getElementById('frequency').value,
        dayOfWeek: document.getElementById('frequency').value === 'weekly' ? document.getElementById('dayOfWeek').value : null
      };

      try {
        const res = await fetch(`/admin/api/scheduled/${currentGuildId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          document.getElementById('message').value = '';
          loadSchedules();
        } else {
          const result = await res.json();
          alert(result.error || 'Failed to create schedule');
        }
      } catch (err) {
        alert('Error creating schedule');
      }
    }

    async function deleteSchedule(id) {
      if (!confirm('Delete this scheduled message?')) return;
      await fetch(`/admin/api/scheduled/${currentGuildId}/${id}`, { method: 'DELETE' });
      loadSchedules();
    }

    document.getElementById('frequency').addEventListener('change', (e) => {
      document.getElementById('dayOfWeekGroup').style.display = e.target.value === 'weekly' ? 'block' : 'none';
    });

    document.getElementById('guildSelect').addEventListener('change', (e) => {
      currentGuildId = e.target.value;
      loadChannels();
      loadSchedules();
    });

    loadGuilds();
  </script>
</body>
</html>
