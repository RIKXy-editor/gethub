<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Config - Admin</title>
  <link rel="stylesheet" href="/admin/css/style.css">
  <style>
    .form-section { padding: 20px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px; max-width: 600px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); }
    .toggle-row { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 16px; }
    .toggle-row input[type="checkbox"] { width: 20px; height: 20px; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header"><h1>Editors Club Official</h1></div>
    <ul class="sidebar-nav">
      <li><a href="/admin"><span class="icon">ğŸ“Š</span> Dashboard</a></li>
      <li><a href="/admin/tickets"><span class="icon">ğŸ«</span> Tickets</a></li>
      <li><a href="/admin/panels"><span class="icon">ğŸ“‹</span> Panels</a></li>
      <li><a href="/admin/embed-builder"><span class="icon">ğŸ¨</span> Embed Builder</a></li>
      <li><a href="/admin/welcome"><span class="icon">ğŸ‘‹</span> Welcome</a></li>
      <li><a href="/admin/keywords"><span class="icon">ğŸ”‘</span> Keywords</a></li>
      <li><a href="/admin/giveaways"><span class="icon">ğŸ</span> Giveaways</a></li>
      <li><a href="/admin/announcements"><span class="icon">ğŸ“¢</span> Announcements</a></li>
      <li><a href="/admin/scheduled"><span class="icon">â°</span> Scheduled</a></li>
      <li><a href="/admin/sticky"><span class="icon">ğŸ“Œ</span> Sticky</a></li>
      <li><a href="/admin/sticky-clients"><span class="icon">ğŸ‘¥</span> Client Finder</a></li>
      <li><a href="/admin/dm-sender"><span class="icon">âœ‰ï¸</span> DM Sender</a></li>
      <li><a href="/admin/job-config" class="active"><span class="icon">ğŸ’¼</span> Job Config</a></li>
      <li><a href="/admin/bot-settings"><span class="icon">ğŸ¤–</span> Bot Settings</a></li>
      <li><a href="/admin/settings"><span class="icon">âš™ï¸</span> Settings</a></li>
      <li><a href="/admin/logout"><span class="icon">ğŸšª</span> Logout</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="page-header">
      <h2>Job Posting Configuration</h2>
      <p>Configure the job posting system for your server</p>
    </div>

    <div class="form-section" style="padding:16px;max-width:none;">
      <label style="margin-right:10px;">Select Server:</label>
      <select id="guildSelect" style="width:auto;display:inline-block;padding:8px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);"></select>
    </div>

    <div class="form-section">
      <div class="toggle-row">
        <input type="checkbox" id="enabled">
        <span><strong>Enable Job Posting</strong></span>
      </div>
      
      <div class="form-group">
        <label>Job Posting Channel</label>
        <select id="channelId"></select>
      </div>
      
      <div class="form-group">
        <label>Required Role (optional)</label>
        <select id="roleId">
          <option value="">No requirement</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Cooldown (hours)</label>
        <input type="number" id="cooldown" value="24" min="1" max="168">
      </div>
      
      <div class="form-group">
        <label>Banner Text (shown above Post Job button)</label>
        <textarea id="bannerText" placeholder="Looking to hire? Post your job listing here!" style="min-height:80px;"></textarea>
      </div>
      
      <button class="btn btn-primary" style="width:100%;" onclick="saveConfig()">Save Configuration</button>
    </div>
  </main>

  <script src="/admin/js/unsaved.js"></script>
  <script>
    let currentGuildId = null;

    async function loadGuilds() {
      const res = await fetch('/admin/api/discord/guilds');
      const guilds = await res.json();
      const select = document.getElementById('guildSelect');
      guilds.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name;
        select.appendChild(opt);
      });
      if (guilds.length > 0) {
        currentGuildId = guilds[0].id;
        loadChannels();
        loadRoles();
        loadConfig();
      }
    }

    async function loadChannels() {
      const res = await fetch(`/admin/api/discord/guilds/${currentGuildId}/channels`);
      const channels = await res.json();
      document.getElementById('channelId').innerHTML = '<option value="">Select channel...</option>' + channels.map(ch => `<option value="${ch.id}">#${ch.name}</option>`).join('');
    }

    async function loadRoles() {
      const res = await fetch(`/admin/api/discord/guilds/${currentGuildId}/roles`);
      const roles = await res.json();
      document.getElementById('roleId').innerHTML = '<option value="">No requirement</option>' + roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
    }

    async function loadConfig() {
      const res = await fetch(`/admin/api/job-config/${currentGuildId}`);
      const config = await res.json();
      document.getElementById('enabled').checked = config.enabled || false;
      document.getElementById('channelId').value = config.channelId || '';
      document.getElementById('roleId').value = config.roleId || '';
      document.getElementById('cooldown').value = Math.floor((config.cooldown || 86400000) / 3600000);
      document.getElementById('bannerText').value = config.bannerText || '';
      setTimeout(() => UnsavedChanges.refresh && UnsavedChanges.refresh(), 100);
    }

    async function saveConfig() {
      const data = {
        enabled: document.getElementById('enabled').checked,
        channelId: document.getElementById('channelId').value || null,
        roleId: document.getElementById('roleId').value || null,
        cooldown: parseInt(document.getElementById('cooldown').value) * 3600000,
        bannerText: document.getElementById('bannerText').value
      };
      const res = await fetch(`/admin/api/job-config/${currentGuildId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (res.ok) {
        alert('Configuration saved!');
        UnsavedChanges.markSaved();
      } else {
        alert('Failed to save');
      }
    }

    document.getElementById('guildSelect').addEventListener('change', (e) => {
      currentGuildId = e.target.value;
      loadChannels();
      loadRoles();
      loadConfig();
    });

    UnsavedChanges.init(saveConfig);
    loadGuilds();
  </script>
</body>
</html>
