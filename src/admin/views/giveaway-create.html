<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Giveaway - Admin</title>
  <link rel="stylesheet" href="/admin/css/style.css">
  <style>
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 800px) { .form-grid { grid-template-columns: 1fr; } }
    .form-section { padding: 20px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px; }
    .form-section h4 { margin: 0 0 16px; color: var(--accent-color); font-size: 14px; text-transform: uppercase; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); }
    .duration-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .role-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .role-tag { padding: 4px 10px; background: var(--bg-secondary); border-radius: 12px; font-size: 12px; display: flex; align-items: center; gap: 6px; }
    .role-tag button { background: none; border: none; color: #ff6b6b; cursor: pointer; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header"><h1>Editors Club Official</h1></div>
    <ul class="sidebar-nav">
      <li><a href="/admin"><span class="icon">ğŸ“Š</span> Dashboard</a></li>
      <li><a href="/admin/tickets"><span class="icon">ğŸ«</span> Tickets</a></li>
      <li><a href="/admin/panels"><span class="icon">ğŸ“‹</span> Panels</a></li>
      <li><a href="/admin/embed-builder"><span class="icon">ğŸ¨</span> Embed Builder</a></li>
      <li><a href="/admin/welcome"><span class="icon">ğŸ‘‹</span> Welcome</a></li>
      <li><a href="/admin/keywords"><span class="icon">ğŸ”‘</span> Keywords</a></li>
      <li><a href="/admin/giveaways" class="active"><span class="icon">ğŸ</span> Giveaways</a></li>
      <li><a href="/admin/announcements"><span class="icon">ğŸ“¢</span> Announcements</a></li>
      <li><a href="/admin/scheduled"><span class="icon">â°</span> Scheduled</a></li>
      <li><a href="/admin/sticky"><span class="icon">ğŸ“Œ</span> Sticky</a></li>
      <li><a href="/admin/sticky-clients"><span class="icon">ğŸ‘¥</span> Client Finder</a></li>
      <li><a href="/admin/dm-sender"><span class="icon">âœ‰ï¸</span> DM Sender</a></li>
      <li><a href="/admin/job-config"><span class="icon">ğŸ’¼</span> Job Config</a></li>
      <li><a href="/admin/bot-settings"><span class="icon">ğŸ¤–</span> Bot Settings</a></li>
      <li><a href="/admin/settings"><span class="icon">âš™ï¸</span> Settings</a></li>
      <li><a href="/admin/logout"><span class="icon">ğŸšª</span> Logout</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="page-header">
      <h2>Create New Giveaway</h2>
      <p>Set up a new giveaway for your server</p>
    </div>

    <div class="form-section" style="padding:16px;">
      <label style="margin-right:10px;">Select Server:</label>
      <select id="guildSelect" style="width:auto;display:inline-block;padding:8px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);"></select>
    </div>

    <div class="form-grid">
      <div>
        <div class="form-section">
          <h4>Giveaway Details</h4>
          <div class="form-group">
            <label>Prize</label>
            <input type="text" id="prize" placeholder="What's being given away?">
          </div>
          <div class="form-group">
            <label>Channel</label>
            <select id="channelId"></select>
          </div>
          <div class="form-group">
            <label>Number of Winners</label>
            <input type="number" id="winnerCount" value="1" min="1" max="10">
          </div>
        </div>

        <div class="form-section">
          <h4>Duration</h4>
          <div class="duration-grid">
            <div class="form-group">
              <label>Days</label>
              <input type="number" id="days" value="0" min="0">
            </div>
            <div class="form-group">
              <label>Hours</label>
              <input type="number" id="hours" value="1" min="0" max="23">
            </div>
            <div class="form-group">
              <label>Minutes</label>
              <input type="number" id="minutes" value="0" min="0" max="59">
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="form-section">
          <h4>Requirements (Optional)</h4>
          <div class="form-group">
            <label>Required Role</label>
            <select id="requiredRoleId">
              <option value="">No requirement</option>
            </select>
          </div>
        </div>

        <div class="form-section">
          <h4>Multiplier Roles (Optional)</h4>
          <p style="color:var(--text-secondary);font-size:12px;margin-bottom:12px;">Give certain roles extra entries</p>
          <div style="display:flex;gap:8px;">
            <select id="multiplierRole" style="flex:1;"></select>
            <input type="number" id="multiplierValue" placeholder="x" min="2" max="10" style="width:60px;">
            <button class="btn btn-secondary" onclick="addMultiplier()">Add</button>
          </div>
          <div id="multiplierList" class="role-list"></div>
        </div>
      </div>
    </div>

    <button class="btn btn-primary" style="width:100%;padding:14px;font-size:16px;" onclick="createGiveaway()">Create Giveaway</button>
    <a href="/admin/giveaways" style="display:block;text-align:center;margin-top:12px;color:var(--text-secondary);">Back to Giveaways</a>
  </main>

  <script>
    let currentGuildId = null;
    let roles = [];
    let multipliers = {};

    async function loadGuilds() {
      const res = await fetch('/admin/api/discord/guilds');
      const guilds = await res.json();
      const select = document.getElementById('guildSelect');
      guilds.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name;
        select.appendChild(opt);
      });
      if (guilds.length > 0) {
        currentGuildId = guilds[0].id;
        loadChannels();
        loadRoles();
      }
    }

    async function loadChannels() {
      const res = await fetch(`/admin/api/discord/guilds/${currentGuildId}/channels`);
      const channels = await res.json();
      const select = document.getElementById('channelId');
      select.innerHTML = channels.map(ch => `<option value="${ch.id}">#${ch.name}</option>`).join('');
    }

    async function loadRoles() {
      const res = await fetch(`/admin/api/discord/guilds/${currentGuildId}/roles`);
      roles = await res.json();
      const reqSelect = document.getElementById('requiredRoleId');
      const mulSelect = document.getElementById('multiplierRole');
      reqSelect.innerHTML = '<option value="">No requirement</option>' + roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
      mulSelect.innerHTML = '<option value="">Select role...</option>' + roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
    }

    function addMultiplier() {
      const roleId = document.getElementById('multiplierRole').value;
      const value = parseInt(document.getElementById('multiplierValue').value);
      if (!roleId || !value || value < 2) return;
      const role = roles.find(r => r.id === roleId);
      if (!role) return;
      multipliers[roleId] = value;
      renderMultipliers();
    }

    function removeMultiplier(roleId) {
      delete multipliers[roleId];
      renderMultipliers();
    }

    function renderMultipliers() {
      const container = document.getElementById('multiplierList');
      container.innerHTML = Object.entries(multipliers).map(([id, val]) => {
        const role = roles.find(r => r.id === id);
        return `<div class="role-tag">${role?.name || id} (${val}x) <button onclick="removeMultiplier('${id}')">&times;</button></div>`;
      }).join('');
    }

    async function createGiveaway() {
      const prize = document.getElementById('prize').value.trim();
      if (!prize) { alert('Please enter a prize'); return; }
      const channelId = document.getElementById('channelId').value;
      if (!channelId) { alert('Please select a channel'); return; }
      const days = parseInt(document.getElementById('days').value) || 0;
      const hours = parseInt(document.getElementById('hours').value) || 0;
      const minutes = parseInt(document.getElementById('minutes').value) || 0;
      const totalMs = (days * 86400 + hours * 3600 + minutes * 60) * 1000;
      if (totalMs < 60000) { alert('Duration must be at least 1 minute'); return; }
      
      const data = {
        channelId,
        prize,
        duration: totalMs,
        winnerCount: parseInt(document.getElementById('winnerCount').value) || 1,
        requiredRoleId: document.getElementById('requiredRoleId').value || null,
        multiplierRoles: Object.keys(multipliers).length > 0 ? multipliers : null
      };

      try {
        const res = await fetch(`/admin/api/giveaways/${currentGuildId}/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (res.ok) {
          alert('Giveaway created successfully!');
          window.location.href = '/admin/giveaways';
        } else {
          alert(result.error || 'Failed to create giveaway');
        }
      } catch (err) {
        alert('Error creating giveaway');
      }
    }

    document.getElementById('guildSelect').addEventListener('change', (e) => {
      currentGuildId = e.target.value;
      loadChannels();
      loadRoles();
      multipliers = {};
      renderMultipliers();
    });

    loadGuilds();
  </script>
</body>
</html>
