<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Editors Club Official</title>
  <link rel="stylesheet" href="/admin/css/style.css">
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ« Editors Club Official</h1>
    </div>
    <ul class="sidebar-nav">
      <li><a href="/admin" class="active"><span class="icon">ğŸ“Š</span> Dashboard</a></li>
      <li><a href="/admin/tickets"><span class="icon">ğŸ«</span> Tickets</a></li>
      <li><a href="/admin/panels"><span class="icon">ğŸ“‹</span> Panels</a></li>
      <li><a href="/admin/embed-builder"><span class="icon">ğŸ¨</span> Embed Builder</a></li>
      <li><a href="/admin/welcome"><span class="icon">ğŸ‘‹</span> Welcome</a></li>
      <li><a href="/admin/keywords"><span class="icon">ğŸ”‘</span> Keywords</a></li>
      <li><a href="/admin/giveaways"><span class="icon">ğŸ</span> Giveaways</a></li>
      <li><a href="/admin/announcements"><span class="icon">ğŸ“¢</span> Announcements</a></li>
      <li><a href="/admin/scheduled"><span class="icon">â°</span> Scheduled</a></li>
      <li><a href="/admin/sticky"><span class="icon">ğŸ“Œ</span> Sticky</a></li>
      <li><a href="/admin/sticky-clients"><span class="icon">ğŸ‘¥</span> Client Finder</a></li>
      <li><a href="/admin/dm-sender"><span class="icon">âœ‰ï¸</span> DM Sender</a></li>
      <li><a href="/admin/job-config"><span class="icon">ğŸ’¼</span> Job Config</a></li>
      <li><a href="/admin/bot-settings"><span class="icon">ğŸ¤–</span> Bot Settings</a></li>
      <li><a href="/admin/settings"><span class="icon">âš™ï¸</span> Settings</a></li>
      <li><a href="/admin/stats"><span class="icon">ğŸ“ˆ</span> Staff Stats</a></li>
      <li><a href="/admin/logout"><span class="icon">ğŸšª</span> Logout</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="page-header">
      <h2>Dashboard</h2>
      <p>Overview of your ticket system</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon">ğŸ«</div>
        <div class="value" id="totalTickets">0</div>
        <div class="label">Total Tickets</div>
      </div>
      <div class="stat-card">
        <div class="icon">ğŸŸ¢</div>
        <div class="value" id="openTickets">0</div>
        <div class="label">Open Tickets</div>
      </div>
      <div class="stat-card">
        <div class="icon">ğŸ”’</div>
        <div class="value" id="closedTickets">0</div>
        <div class="label">Closed Tickets</div>
      </div>
      <div class="stat-card">
        <div class="icon">ğŸ‘¥</div>
        <div class="value" id="staffCount">0</div>
        <div class="label">Active Staff</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Recent Tickets</h3>
        <a href="/admin/tickets" class="btn btn-secondary btn-sm">View All</a>
      </div>
      <div class="card-body">
        <table class="table">
          <thead>
            <tr>
              <th>Ticket #</th>
              <th>Opened By</th>
              <th>Status</th>
              <th>Plan</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="recentTickets">
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    async function loadDashboard() {
      try {
        const res = await fetch('/admin/api/tickets');
        const tickets = await res.json();
        
        const open = tickets.filter(t => t.status === 'open').length;
        const closed = tickets.filter(t => t.status === 'closed').length;
        
        document.getElementById('totalTickets').textContent = tickets.length;
        document.getElementById('openTickets').textContent = open;
        document.getElementById('closedTickets').textContent = closed;
        
        const guildsRes = await fetch('/admin/api/guilds');
        const guilds = await guildsRes.json();
        if (guilds.length > 0) {
          const statsRes = await fetch(`/admin/api/stats/${guilds[0].id}`);
          const stats = await statsRes.json();
          document.getElementById('staffCount').textContent = Object.keys(stats.staffStats || {}).length;
        }
        
        const recentTickets = tickets
          .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
          .slice(0, 5);
        
        const tbody = document.getElementById('recentTickets');
        if (recentTickets.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-secondary)">No tickets yet</td></tr>';
        } else {
          tbody.innerHTML = recentTickets.map(t => `
            <tr>
              <td>#${t.ticketNumber || 'N/A'}</td>
              <td>${t.openerTag || 'Unknown'}</td>
              <td><span class="badge ${t.status === 'open' ? 'badge-success' : 'badge-danger'}">${t.status || 'unknown'}</span></td>
              <td>${t.selectedPlan || '-'}</td>
              <td>${t.createdAt ? new Date(t.createdAt).toLocaleDateString() : 'N/A'}</td>
            </tr>
          `).join('');
        }
      } catch (err) {
        console.error('Error loading dashboard:', err);
      }
    }
    
    loadDashboard();
  </script>
</body>
</html>
