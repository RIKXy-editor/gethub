<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Giveaways - Ticket Admin</title>
  <link rel="stylesheet" href="/admin/css/style.css">
  <style>
    .giveaway-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; margin-top: 20px; }
    .giveaway-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
    .giveaway-header { padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .giveaway-status { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .status-active { background: rgba(67, 181, 129, 0.2); color: #43b581; }
    .status-ended { background: rgba(114, 118, 125, 0.2); color: #72767d; }
    .giveaway-body { padding: 16px; }
    .giveaway-prize { font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; }
    .giveaway-info { display: grid; gap: 8px; font-size: 13px; color: var(--text-secondary); }
    .giveaway-info-row { display: flex; justify-content: space-between; }
    .giveaway-actions { padding: 16px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; }
    .giveaway-actions button { flex: 1; }
    .countdown { font-family: monospace; color: var(--accent-color); font-weight: 600; }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state h3 { color: var(--text-primary); margin-bottom: 8px; }
    .filter-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
    .filter-tab { padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; }
    .filter-tab:hover { border-color: var(--accent-color); }
    .filter-tab.active { background: var(--accent-color); border-color: var(--accent-color); color: white; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header"><h1>Ticket Admin</h1></div>
    <ul class="sidebar-nav">
      <li><a href="/admin"><span class="icon">ğŸ“Š</span> Dashboard</a></li>
      <li><a href="/admin/tickets"><span class="icon">ğŸ«</span> Tickets</a></li>
      <li><a href="/admin/panels"><span class="icon">ğŸ“‹</span> Panels</a></li>
      <li><a href="/admin/embed-builder"><span class="icon">ğŸ¨</span> Embed Builder</a></li>
      <li><a href="/admin/welcome"><span class="icon">ğŸ‘‹</span> Welcome</a></li>
      <li><a href="/admin/keywords"><span class="icon">ğŸ”‘</span> Keywords</a></li>
      <li><a href="/admin/giveaways" class="active"><span class="icon">ğŸ</span> Giveaways</a></li>
      <li><a href="/admin/settings"><span class="icon">âš™ï¸</span> Settings</a></li>
      <li><a href="/admin/stats"><span class="icon">ğŸ“ˆ</span> Staff Stats</a></li>
      <li><a href="/admin/logout"><span class="icon">ğŸšª</span> Logout</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="page-header">
      <h2>Giveaway Management</h2>
      <p>View and manage all giveaways in your server</p>
    </div>

    <div class="form-section" style="padding:16px;background:var(--card-bg);border-radius:8px;border:1px solid var(--border-color);margin-bottom:20px;">
      <label style="margin-right:10px;">Select Server:</label>
      <select id="guildSelect" class="form-control" style="width:auto;display:inline-block;"></select>
    </div>

    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all" onclick="setFilter('all')">All</button>
      <button class="filter-tab" data-filter="active" onclick="setFilter('active')">Active</button>
      <button class="filter-tab" data-filter="ended" onclick="setFilter('ended')">Ended</button>
    </div>

    <div id="giveawayContainer">
      <div class="empty-state">
        <h3>No Giveaways</h3>
        <p>Create giveaways using the /gcreate command in Discord</p>
      </div>
    </div>
  </main>

  <script>
    let currentGuildId = null;
    let giveaways = [];
    let currentFilter = 'all';

    async function loadGuilds() {
      const res = await fetch('/admin/api/discord/guilds');
      const guilds = await res.json();
      const select = document.getElementById('guildSelect');
      guilds.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name;
        select.appendChild(opt);
      });
      if (guilds.length > 0) {
        currentGuildId = guilds[0].id;
        loadGiveaways();
      }
    }

    async function loadGiveaways() {
      if (!currentGuildId) return;
      const res = await fetch(`/admin/api/giveaways/${currentGuildId}`);
      giveaways = await res.json();
      renderGiveaways();
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
      renderGiveaways();
    }

    function renderGiveaways() {
      const container = document.getElementById('giveawayContainer');
      let filtered = giveaways;
      if (currentFilter === 'active') {
        filtered = giveaways.filter(g => !g.isEnded);
      } else if (currentFilter === 'ended') {
        filtered = giveaways.filter(g => g.isEnded);
      }

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No ${currentFilter === 'all' ? '' : currentFilter + ' '}Giveaways</h3>
            <p>Create giveaways using the /gcreate command in Discord</p>
          </div>
        `;
        return;
      }

      container.innerHTML = '<div class="giveaway-grid">' + filtered.map(g => {
        const isEnded = g.isEnded;
        const endTime = new Date(g.endTime);
        const timeRemaining = endTime - Date.now();
        
        return `
          <div class="giveaway-card">
            <div class="giveaway-header">
              <span class="giveaway-status ${isEnded ? 'status-ended' : 'status-active'}">${isEnded ? 'Ended' : 'Active'}</span>
              <span style="color:var(--text-secondary);font-size:12px;">#${g.channelName || 'unknown'}</span>
            </div>
            <div class="giveaway-body">
              <div class="giveaway-prize">${g.prize || 'Unknown Prize'}</div>
              <div class="giveaway-info">
                <div class="giveaway-info-row">
                  <span>Winners:</span>
                  <span>${g.winnerCount || 1}</span>
                </div>
                <div class="giveaway-info-row">
                  <span>Entries:</span>
                  <span>${g.entries?.length || 0}</span>
                </div>
                <div class="giveaway-info-row">
                  <span>${isEnded ? 'Ended:' : 'Ends:'}</span>
                  <span class="${isEnded ? '' : 'countdown'}">${isEnded ? endTime.toLocaleDateString() : formatTimeRemaining(timeRemaining)}</span>
                </div>
                <div class="giveaway-info-row">
                  <span>Host:</span>
                  <span>${g.hostTag || 'Unknown'}</span>
                </div>
              </div>
            </div>
            <div class="giveaway-actions">
              ${!isEnded ? `<button class="btn btn-secondary" onclick="endGiveaway('${g.messageId}')">End Now</button>` : ''}
              <button class="btn btn-secondary" onclick="deleteGiveaway('${g.messageId}')">Delete</button>
            </div>
          </div>
        `;
      }).join('') + '</div>';
    }

    function formatTimeRemaining(ms) {
      if (ms <= 0) return 'Ending...';
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const mins = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      if (hours > 24) {
        const days = Math.floor(hours / 24);
        return `${days}d ${hours % 24}h`;
      }
      return `${hours}h ${mins}m`;
    }

    async function endGiveaway(messageId) {
      if (!confirm('End this giveaway now?')) return;
      const res = await fetch(`/admin/api/giveaways/${currentGuildId}/end/${messageId}`, { method: 'POST' });
      if (res.ok) {
        loadGiveaways();
      } else {
        alert('Failed to end giveaway');
      }
    }

    async function deleteGiveaway(messageId) {
      if (!confirm('Delete this giveaway? This cannot be undone.')) return;
      const res = await fetch(`/admin/api/giveaways/${currentGuildId}/${messageId}`, { method: 'DELETE' });
      if (res.ok) {
        loadGiveaways();
      } else {
        alert('Failed to delete giveaway');
      }
    }

    document.getElementById('guildSelect').addEventListener('change', (e) => {
      currentGuildId = e.target.value;
      loadGiveaways();
    });

    loadGuilds();
    setInterval(() => {
      if (giveaways.some(g => !g.isEnded)) renderGiveaways();
    }, 60000);
  </script>
</body>
</html>
