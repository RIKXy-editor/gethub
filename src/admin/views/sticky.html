<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sticky Messages - Admin</title>
  <link rel="stylesheet" href="/admin/css/style.css">
  <style>
    .sticky-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 900px) { .sticky-grid { grid-template-columns: 1fr; } }
    .form-section { padding: 20px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); }
    .sticky-item { padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; }
    .sticky-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .sticky-channel { color: var(--accent-color); font-weight: 600; }
    .sticky-content { color: var(--text-primary); font-size: 14px; white-space: pre-wrap; }
    .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header"><h1>Editors Club Official</h1></div>
    <ul class="sidebar-nav">
      <li><a href="/admin"><span class="icon">ğŸ“Š</span> Dashboard</a></li>
      <li><a href="/admin/tickets"><span class="icon">ğŸ«</span> Tickets</a></li>
      <li><a href="/admin/panels"><span class="icon">ğŸ“‹</span> Panels</a></li>
      <li><a href="/admin/embed-builder"><span class="icon">ğŸ¨</span> Embed Builder</a></li>
      <li><a href="/admin/welcome"><span class="icon">ğŸ‘‹</span> Welcome</a></li>
      <li><a href="/admin/keywords"><span class="icon">ğŸ”‘</span> Keywords</a></li>
      <li><a href="/admin/giveaways"><span class="icon">ğŸ</span> Giveaways</a></li>
      <li><a href="/admin/announcements"><span class="icon">ğŸ“¢</span> Announcements</a></li>
      <li><a href="/admin/scheduled"><span class="icon">â°</span> Scheduled</a></li>
      <li><a href="/admin/sticky" class="active"><span class="icon">ğŸ“Œ</span> Sticky</a></li>
      <li><a href="/admin/dm-sender"><span class="icon">âœ‰ï¸</span> DM Sender</a></li>
      <li><a href="/admin/job-config"><span class="icon">ğŸ’¼</span> Job Config</a></li>
      <li><a href="/admin/bot-settings"><span class="icon">ğŸ¤–</span> Bot Settings</a></li>
      <li><a href="/admin/settings"><span class="icon">âš™ï¸</span> Settings</a></li>
      <li><a href="/admin/logout"><span class="icon">ğŸšª</span> Logout</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="page-header">
      <h2>Sticky Messages</h2>
      <p>Create messages that stay at the bottom of channels</p>
    </div>

    <div class="form-section" style="padding:16px;">
      <label style="margin-right:10px;">Select Server:</label>
      <select id="guildSelect" style="width:auto;display:inline-block;padding:8px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);"></select>
    </div>

    <div class="sticky-grid">
      <div class="form-section">
        <h3 style="margin:0 0 16px;color:var(--accent-color);">Create Sticky Message</h3>
        <div class="form-group">
          <label>Channel</label>
          <select id="channelId"></select>
        </div>
        <div class="form-group">
          <label>Message</label>
          <textarea id="message" placeholder="Your sticky message..." style="min-height:120px;"></textarea>
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="createSticky()">Create Sticky</button>
      </div>

      <div>
        <h3 style="margin:0 0 16px;color:var(--accent-color);">Active Sticky Messages</h3>
        <div id="stickyList">
          <div class="empty-state">Loading...</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentGuildId = null;
    let stickies = [];

    async function loadGuilds() {
      const res = await fetch('/admin/api/discord/guilds');
      const guilds = await res.json();
      const select = document.getElementById('guildSelect');
      guilds.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name;
        select.appendChild(opt);
      });
      if (guilds.length > 0) {
        currentGuildId = guilds[0].id;
        loadChannels();
        loadStickies();
      }
    }

    async function loadChannels() {
      const res = await fetch(`/admin/api/discord/guilds/${currentGuildId}/channels`);
      const channels = await res.json();
      document.getElementById('channelId').innerHTML = channels.map(ch => `<option value="${ch.id}">#${ch.name}</option>`).join('');
    }

    async function loadStickies() {
      const res = await fetch(`/admin/api/sticky/${currentGuildId}`);
      stickies = await res.json();
      renderStickies();
    }

    function renderStickies() {
      const container = document.getElementById('stickyList');
      if (stickies.length === 0) {
        container.innerHTML = '<div class="empty-state">No active sticky messages</div>';
        return;
      }
      container.innerHTML = stickies.map(s => `
        <div class="sticky-item">
          <div class="sticky-header">
            <span class="sticky-channel">#${s.channelName || s.channelId}</span>
            <button class="btn btn-secondary" onclick="deleteSticky('${s.channelId}')" style="padding:4px 12px;font-size:12px;">Remove</button>
          </div>
          <div class="sticky-content">${s.content.substring(0, 150)}${s.content.length > 150 ? '...' : ''}</div>
        </div>
      `).join('');
    }

    async function createSticky() {
      const channelId = document.getElementById('channelId').value;
      const message = document.getElementById('message').value.trim();
      if (!message) { alert('Please enter a message'); return; }

      try {
        const res = await fetch(`/admin/api/sticky/${currentGuildId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channelId, content: message })
        });
        if (res.ok) {
          document.getElementById('message').value = '';
          loadStickies();
        } else {
          const result = await res.json();
          alert(result.error || 'Failed to create sticky');
        }
      } catch (err) {
        alert('Error creating sticky');
      }
    }

    async function deleteSticky(channelId) {
      if (!confirm('Remove this sticky message?')) return;
      await fetch(`/admin/api/sticky/${currentGuildId}/${channelId}`, { method: 'DELETE' });
      loadStickies();
    }

    document.getElementById('guildSelect').addEventListener('change', (e) => {
      currentGuildId = e.target.value;
      loadChannels();
      loadStickies();
    });

    loadGuilds();
  </script>
</body>
</html>
